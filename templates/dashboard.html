{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

{% include 'modais/confirmacaoAptoCoordenacao.html' %}

<h2>Dashboard de Agendamentos</h2>

{% if current_user.is_admin %}
<!-- Admin Dashboard Cards -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card text-white bg-primary h-100">
            <div class="card-body">
                <h5 class="card-title">Agendamentos Abertos</h5>
                <p class="card-text fs-3">{{ admin_total_agendamentos_abertos }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card text-white bg-success h-100">
            <div class="card-body">
                <h5 class="card-title">Agendamentos Conclu√≠dos</h5>
                <p class="card-text fs-3">{{ admin_total_agendamentos_concluidos }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Admin Tables Section -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">Contagem por Status</div>
            <div class="card-body">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Quantidade</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for status, count in admin_status_counts_table %}
                        <tr>
                            <td>{{ status }}</td>
                            <td><span class="badge bg-primary rounded-pill">{{ count }}</span></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="2" class="text-center">Nenhum status encontrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">Contagem por Coordenador</div>
            <div class="card-body">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Coordenador</th>
                            <th>Quantidade</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for coordenador, count in admin_coordenador_counts_table %}
                        <tr>
                            <td>{{ coordenador }}</td>
                            <td><span class="badge bg-primary rounded-pill">{{ count }}</span></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="2" class="text-center">Nenhum coordenador encontrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">Contagem por Setor</div>
            <div class="card-body">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Setor</th>
                            <th>Quantidade</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for setor, count in admin_setor_counts_table %}
                        <tr>
                            <td>{{ setor }}</td>
                            <td><span class="badge bg-primary rounded-pill">{{ count }}</span></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="2" class="text-center">Nenhum setor encontrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- User Dashboard Cards -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card text-white bg-primary h-100">
            <div class="card-body">
                <h5 class="card-title">Meus Agendamentos Abertos</h5>
                <p class="card-text fs-3">{{ total_agendamentos_abertos }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card text-white bg-success h-100">
            <div class="card-body">
                <h5 class="card-title">Meus Agendamentos Conclu√≠dos</h5>
                <p class="card-text fs-3">{{ total_agendamentos_concluidos }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Filter Form -->

<form method="GET" class="row g-3 mb-4">
    <div class="col-md-3">
        <label for="data" class="form-label">Data</label>
        <input type="date" class="form-control" id="data" name="data" value="{{ request.args.get('data', '') }}">
    </div>
    <div class="col-md-3">
        <label for="status" class="form-label">Status</label>
        <select id="status" name="status" class="form-select">
            <option value="">Todos</option>
            {% for status_obj in statuses %}
                <option value="{{ status_obj.nome }}" {% if request.args.get('status') == status_obj.nome %}selected{% endif %}>
                    {{ status_obj.nome }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <label for="setor" class="form-label">Setor</label>
        <select name="setor" id="setor" class="form-control">
            <option value="">Todos</option>
            {% for setor in setores %}
                <option value="{{ setor.nome }}" {% if request.args.get('setor') == setor.nome %}selected{% endif %}>
                    {{ setor.nome }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4 align-self-end">
        <button type="submit" formaction="{{ url_for('dashboard') }}" class="btn btn-primary">Filtrar</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Limpar</a>
        <button type="submit" formaction="{{ url_for('export_excel') }}" class="btn btn-secondary">Exportar Excel</button>
    </div>
</form>


<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Data Agendamento</th>
                <th>Hor√°rio</th>
                <th>Canal</th>
                <th>Contato</th>
                <th>Nome do Respons√°vel 1</th>
                <th>CPF do Respons√°vel 1</th>
                <th>Nome do Respons√°vel 2</th>
                <th>CPF do Respons√°vel 2</th>
                <th>Status</th>
                <th>Setor</th>
                <th>Aluno</th>
                <th>Escola do Aluno</th>
                <th>Coordenador</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for agendamento in agendamentos %}
            <tr>
                <td>{{ agendamento.id }}</td>
                <td>{{ agendamento.data_agendamento.strftime('%d/%m/%Y') }}</td>
                <td>{{ agendamento.horario.strftime('%H:%M') }}</td>
                <td>{{ agendamento.canal }}</td>
                <td>{{ agendamento.contato }}</td>
                <td>{{ agendamento.nome_responsavel_1 }}</td>
                <td>{{ agendamento.cpf_responsavel_1 }}</td>
                <td>{{ agendamento.nome_responsavel_2 }}</td>
                <td>{{ agendamento.cpf_responsavel_2 }}</td>
                <td><span class="{{ agendamento.status|status_class }}">{{ agendamento.status }}</span></td>
                <td>{{ agendamento.setor }}</td>
                <td>{{ agendamento.aluno }}</td>
                <td>{{ agendamento.escolaAluno }}</td>
                <td>{{ agendamento.coordenador }}</td>
                <td>
                    {% if current_user.is_admin %}
                        <a href="{{ url_for('editar_agendamento', id=agendamento.id) }}" class="btn btn-sm btn-warning">Editar</a>
                        <form action="{{ url_for('excluir_agendamento', id=agendamento.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir?');">
                            <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
                        </form>
                    {% else %}
                        {% set is_locked = (current_user.perfil != 'financeiro' and not current_user.is_admin and agendamento.setor == 'Financeiro') %}
                        
                        <form action="{{ url_for('checkout_agendamento', id=agendamento.id) }}" 
                              method="POST" 
                              class="d-inline agendamento-form" 
                              data-agendamento-id="{{ agendamento.id }}"
                              data-is-locked="{{ 'true' if is_locked else 'false' }}">
                            
                            <div class="mb-2">
                                <label for="status-{{ agendamento.id }}" class="form-label visually-hidden">Status</label>
                                <select name="status" 
                                        id="status-{{ agendamento.id }}" 
                                        class="form-select status-select"
                                        data-agendamento-id="{{ agendamento.id }}"
                                        {% if is_locked %}disabled{% endif %}>
                                    
                                    {% for status_obj in statuses %}
                                        {% if current_user.perfil == 'financeiro' and status_obj.nome in ['Apto-Financeiro', 'N√£o-Apto-Financeiro'] %}
                                            <option value="{{ status_obj.nome }}" {% if agendamento.status == status_obj.nome %}selected{% endif %}>
                                                {{ status_obj.nome }}
                                            </option>
                                        {% elif current_user.perfil != 'financeiro' and status_obj.nome in [
                                            'Aberto-Coordena√ß√£o',
                                            'Em andamento-Coordena√ß√£o',
                                            'Remarcado-Coordena√ß√£o',
                                            'Apto-Coordena√ß√£o',
                                            'N√£o-Apto-Coordena√ß√£o'
                                        ] %}
                                            <option value="{{ status_obj.nome }}" {% if agendamento.status == status_obj.nome %}selected{% endif %}>
                                                {{ status_obj.nome }}
                                            </option>
                                        {% elif current_user.perfil == 'admin' or current_user.is_admin %}
                                            <option value="{{ status_obj.nome }}" {% if agendamento.status == status_obj.nome %}selected{% endif %}>
                                                {{ status_obj.nome }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-2">
                                <label for="observacao-{{ agendamento.id }}" class="form-label visually-hidden">Observa√ß√£o</label>
                                <textarea name="observacao" 
                                          id="observacao-{{ agendamento.id }}" 
                                          class="form-control form-control-sm mb-2" 
                                          rows="2" 
                                          placeholder="Adicionar observa√ß√£o"
                                          {% if is_locked %}disabled readonly{% endif %}>{{ agendamento.observacao or '' }}</textarea>
                            </div>
                            
                            <input type="hidden" name="setor" id="setor-{{ agendamento.id }}" value="{{ agendamento.setor }}">
                            
                            {% if is_locked %}
                                <button type="button" class="btn btn-sm btn-secondary" disabled>
                                    <i class="bi bi-lock-fill"></i> Bloqueado
                                </button>
                                <small class="text-muted d-block mt-1">Enviado para Financeiro</small>
                            {% else %}
                                <button type="submit" class="btn btn-sm btn-success btn-update">Atualizar</button>
                            {% endif %}
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="15" class="text-center">Nenhum agendamento encontrado.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

document.addEventListener('DOMContentLoaded', () => {

    // Fun√ß√£o para bloquear formul√°rio
    function lockForm(form) {
        const select = form.querySelector('.status-select');
        const textarea = form.querySelector('textarea');
        const button = form.querySelector('.btn-update');
        
        if (select) select.disabled = true;
        if (textarea) {
            textarea.disabled = true;
            textarea.readOnly = true;
        }
        if (button) {
            button.disabled = true;
            button.classList.remove('btn-success');
            button.classList.add('btn-secondary');
            button.innerHTML = '<i class="bi bi-lock-fill"></i> Bloqueado';
        }
        
        console.log(`üîí Formul√°rio bloqueado para agendamento`);
    }

    // Processar formul√°rios j√° bloqueados ao carregar
    document.querySelectorAll('.agendamento-form[data-is-locked="true"]').forEach(form => {
        lockForm(form);
    });

    // Interceptar mudan√ßas de status
    document.querySelectorAll('.status-select').forEach(select => {
        const agendamentoId = select.dataset.agendamentoId;
        
        select.addEventListener('change', function(e) {
            const newStatus = this.value;
            const form = this.closest('form');
            const currentUserPerfil = '{{ current_user.perfil }}';
            
            console.log(`Status mudado para: ${newStatus} (Perfil: ${currentUserPerfil})`);
            
            // Se usu√°rio da coordena√ß√£o est√° mudando para "Apto-Coordena√ß√£o"
            if (currentUserPerfil !== 'financeiro' && 
                currentUserPerfil !== 'admin' && 
                newStatus === 'Apto-Coordena√ß√£o') {
                
                if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Ao marcar como "Apto-Coordena√ß√£o", este agendamento ser√° enviado para o Financeiro e voc√™ N√ÉO poder√° mais edit√°-lo.\n\nDeseja continuar?')) {
                    console.log(`‚úÖ Usu√°rio confirmou mudan√ßa para Apto-Coordena√ß√£o`);
                } else {
                    // Reverter para o valor anterior
                    this.value = this.defaultValue;
                    console.log(`‚ùå Usu√°rio cancelou mudan√ßa para Apto-Coordena√ß√£o`);
                }
            }
        });
    });

    // Interceptar submit dos formul√°rios
    document.querySelectorAll('.agendamento-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const isLocked = this.dataset.isLocked === 'true';
            
            if (isLocked) {
                e.preventDefault();
                alert('‚ùå Este agendamento est√° bloqueado pois j√° foi enviado para o Financeiro.');
                console.log('üö´ Tentativa de submit bloqueada');
                return false;
            }
            
            const select = this.querySelector('.status-select');
            const currentUserPerfil = '{{ current_user.perfil }}';
            
            if (select && select.value === 'Apto-Coordena√ß√£o' && 
                currentUserPerfil !== 'financeiro' && 
                currentUserPerfil !== 'admin') {
                
                if (!confirm('‚ö†Ô∏è CONFIRMA√á√ÉO FINAL: Este agendamento ser√° enviado para o Financeiro e voc√™ n√£o poder√° mais edit√°-lo.\n\nConfirma a atualiza√ß√£o?')) {
                    e.preventDefault();
                    return false;
                }
            }
        });
    });

    console.log('%c[DEBUG] Sistema de prote√ß√£o configurado com sucesso', 'color: blue; font-weight: bold;');
});

</script>
    


{% endblock %}
   